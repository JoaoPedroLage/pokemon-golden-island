FROM node:20

WORKDIR /app

# Copiar arquivos de depend√™ncias
COPY package*.json ./
COPY prisma ./prisma/

# Instalar depend√™ncias
RUN npm ci

# Copiar c√≥digo fonte
COPY . .

# Gerar Prisma Client
RUN echo "üì¶ Gerando Prisma Client..." && \
    npx prisma generate && \
    echo "‚úÖ Prisma Client gerado"

# Build da aplica√ß√£o com verifica√ß√£o detalhada
RUN echo "üî® Iniciando build da aplica√ß√£o..." && \
    npm run build || (echo "‚ùå Build falhou!" && exit 1) && \
    echo "üì¶ Verificando resultado do build..." && \
    if [ ! -d "dist" ]; then \
      echo "‚ùå Erro: Diret√≥rio dist n√£o foi criado"; \
      echo "Verificando estrutura do projeto:"; \
      ls -la; \
      echo "Verificando se src existe:"; \
      ls -la src/; \
      exit 1; \
    fi && \
    if [ ! -f "dist/src/main.js" ] && [ ! -f "dist/main.js" ]; then \
      echo "‚ùå Erro: Arquivo dist/src/main.js ou dist/main.js n√£o foi criado"; \
      echo "Conte√∫do do diret√≥rio dist:"; \
      ls -la dist/ || echo "Diret√≥rio dist n√£o existe"; \
      echo "Conte√∫do do diret√≥rio dist/src (se existir):"; \
      ls -la dist/src/ 2>/dev/null || echo "Diret√≥rio dist/src n√£o existe"; \
      echo "Verificando se src/main.ts existe:"; \
      ls -la src/main.ts || echo "src/main.ts n√£o encontrado"; \
      exit 1; \
    fi && \
    echo "‚úÖ Build conclu√≠do com sucesso!" && \
    echo "Arquivos gerados em dist/:" && \
    ls -lh dist/ | head -15

# Expor a porta 3001
EXPOSE 3001

# Instalar wait-for-it e postgresql-client para aguardar e verificar o PostgreSQL
RUN apt-get update && apt-get install -y wait-for-it postgresql-client && rm -rf /var/lib/apt/lists/*

# Criar script de inicializa√ß√£o
RUN echo '#!/bin/sh\n\
set -e\n\
echo "=== Iniciando aplica√ß√£o ==="\n\
echo "Aguardando PostgreSQL estar pronto..."\n\
wait-for-it postgres:5432 -t 60 --strict -- echo "PostgreSQL est√° pronto"\n\
echo "Aguardando alguns segundos para garantir que o banco est√° totalmente inicializado..."\n\
sleep 10\n\
# Construir ou corrigir DATABASE_URL\n\
if [ -z "${DATABASE_URL}" ] || [ "${DATABASE_URL}" = "" ] || [ "${DATABASE_URL}" = "null" ]; then\n\
  export DATABASE_URL="postgresql://${POSTGRES_USER:-your_username}:${POSTGRES_PASSWORD:-your_password}@postgres:5432/${POSTGRES_DB:-pokemon_golden_age}"\n\
  echo "DATABASE_URL constru√≠da automaticamente (estava vazia ou inv√°lida)"\n\
else\n\
  echo "Usando DATABASE_URL fornecida via vari√°vel de ambiente"\n\
  # Verificar se come√ßa com protocolo correto\n\
  if ! echo "${DATABASE_URL}" | grep -qE "^(postgresql|postgres)://"; then\n\
    echo "‚ö† DATABASE_URL n√£o come√ßa com postgresql:// ou postgres://, reconstruindo..."\n\
    export DATABASE_URL="postgresql://${POSTGRES_USER:-your_username}:${POSTGRES_PASSWORD:-your_password}@postgres:5432/${POSTGRES_DB:-pokemon_golden_age}"\n\
    echo "‚úì DATABASE_URL reconstru√≠da com protocolo correto"\n\
  else\n\
    # Substituir localhost por postgres se necess√°rio (para Docker)\n\
    if echo "${DATABASE_URL}" | grep -q "@localhost:"; then\n\
      export DATABASE_URL=$(echo "${DATABASE_URL}" | sed "s/@localhost:/@postgres:/g")\n\
      echo "‚úì DATABASE_URL corrigida: localhost substitu√≠do por postgres"\n\
    fi\n\
  fi\n\
fi\n\
echo "DATABASE_URL configurada (ocultando senha): $(echo "$DATABASE_URL" | sed 's/:[^@]*@/:****@/g')"\n\
# Verificar se DATABASE_URL cont√©m postgres (nome do servi√ßo)\n\
if echo "$DATABASE_URL" | grep -q "@postgres:"; then\n\
  echo "‚úì DATABASE_URL est√° configurada corretamente com nome do servi√ßo Docker"\n\
else\n\
  echo "‚ö† AVISO: DATABASE_URL pode n√£o estar usando o nome do servi√ßo Docker correto"\n\
fi\n\
# Verificar conex√£o com o banco antes de continuar\n\
echo "Verificando conex√£o com o banco de dados..."\n\
RETRIES=15\n\
until PGPASSWORD="${POSTGRES_PASSWORD:-your_password}" psql -h postgres -U "${POSTGRES_USER:-your_username}" -d "${POSTGRES_DB:-pokemon_golden_age}" -c "SELECT 1" > /dev/null 2>&1 || [ $RETRIES -eq 0 ]; do\n\
  echo "Aguardando banco estar totalmente dispon√≠vel... ($RETRIES tentativas restantes)"\n\
  RETRIES=$((RETRIES-1))\n\
  sleep 2\n\
done\n\
if [ $RETRIES -eq 0 ]; then\n\
  echo "‚ö† Aviso: N√£o foi poss√≠vel verificar a conex√£o, mas continuando..."\n\
else\n\
  echo "‚úì Conex√£o com o banco verificada"\n\
fi\n\
echo "Executando migrations..."\n\
npx prisma migrate deploy || echo "Migrations j√° aplicadas ou erro ao executar"\n\
echo "Aguardando mais alguns segundos antes de iniciar o servidor..."\n\
sleep 3\n\
# Verificar se o build existe (NestJS gera em dist/src/main.js)\n\
if [ ! -f "/app/dist/src/main.js" ] && [ ! -f "/app/dist/main.js" ]; then\n\
  echo "‚ùå Erro: Arquivo dist/src/main.js ou dist/main.js n√£o encontrado. Executando build..."\n\
  cd /app\n\
  echo "Verificando estrutura antes do build:"\n\
  ls -la /app/src/ | head -5\n\
  echo "Executando build..."\n\
  npm run build\n\
  BUILD_EXIT_CODE=$?\n\
  if [ $BUILD_EXIT_CODE -ne 0 ]; then\n\
    echo "‚ùå Build falhou com c√≥digo de sa√≠da: $BUILD_EXIT_CODE"\n\
    exit 1\n\
  fi\n\
  if [ ! -f "/app/dist/src/main.js" ] && [ ! -f "/app/dist/main.js" ]; then\n\
    echo "‚ùå Erro: Build executado mas dist/src/main.js ou dist/main.js ainda n√£o existe"\n\
    echo "Conte√∫do do diret√≥rio /app:"\n\
    ls -la /app/ | head -10\n\
    echo "Conte√∫do do diret√≥rio dist (se existir):"\n\
    ls -la /app/dist/ 2>/dev/null || echo "Diret√≥rio dist n√£o existe"\n\
    echo "Verificando se src/main.ts existe:"\n\
    ls -la /app/src/main.ts || echo "src/main.ts n√£o encontrado"\n\
    exit 1\n\
  fi\n\
  echo "‚úÖ Build executado com sucesso no runtime"\n\
fi\n\
echo "‚úì Build verificado. Iniciando servidor NestJS..."\n\
exec npm run start:prod' > /app/start.sh && chmod +x /app/start.sh

# Comando para iniciar a aplica√ß√£o
CMD ["/app/start.sh"]

